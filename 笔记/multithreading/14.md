# 14 多图下载综合案例(掌握)

重要部分:

```objc
- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{

    // 1.创建可重用的 cell
    static NSString *reuseId = @"app";
    UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:reuseId];

    // 2.给子控件赋值
    // 2.1模型
    App *app = self.apps[indexPath.row];
    // 2.2 赋值
    cell.textLabel.text = app.name;
    cell.detailTextLabel.text = app.download;

    // 2.3 设置图片
    // (1)检查内存缓存有没有
    UIImage *image = [self.images objectForKey:app.icon];
    if (image) {

        cell.imageView.image = image;
        NSLog(@"%zd ---- 使用了内存缓存", indexPath.row);
    }else{

        // (2)检查沙盒中有没有
        NSString *cachesPath = [NSSearchPathForDirectoriesInDomains(NSCachesDirectory, NSUserDomainMask, YES) lastObject];
        // 获取图片的名称
        NSString *filename = [app.icon lastPathComponent];
        // 拼接路径
        NSString *fullPath = [cachesPath stringByAppendingPathComponent:filename];
        // 获取文件
        NSData *data = [NSData dataWithContentsOfFile:fullPath];
        if (data) {

            // 转换
            UIImage *image = [UIImage imageWithData:data];
            // 赋值
            cell.imageView.image = image;

            // 把图片保存到内存缓存中
            [self.images setObject:image forKey:app.icon];

            NSLog(@"%zd ---- 使用了磁盘缓存(沙盒)中的数据", indexPath.row);
        }else{

            // (3)沙盒中不存在, 则进行图片下载

            // 清空图片或设置占位图片
            cell.imageView.image = [UIImage imageNamed:@"Snip20160316_21.png"];

            // 封装操作(下载图片)
            NSBlockOperation *download = [NSBlockOperation blockOperationWithBlock:^{

                NSURL *url = [NSURL URLWithString:app.icon];
                NSData *data = [NSData dataWithContentsOfURL:url];
                UIImage *image = [UIImage imageWithData:data];

                // 保存图片到缓存
                [self.images setObject:image forKey:app.icon];
                [data writeToFile:fullPath atomically:YES];

                // 刷新 UI(设置图片)
                [[NSOperationQueue mainQueue] addOperationWithBlock:^{

                    // 刷新执行的行
                    [tableView reloadRowsAtIndexPaths:@[indexPath] withRowAnimation:UITableViewRowAnimationMiddle];
                }];
            }];

            NSLog(@"%zd ---- 下载图片 ---- %@", indexPath.row, [NSThread currentThread]);

            // 添加操作到队列中
            [self.queue addOperation:download];
        }
    }

    // 3.返回 cell
    return cell;
}
```
